import streamlit as st
import re
import time
import random

# Configure the page
st.set_page_config(
    page_title="LGL Employee Helper",
    page_icon="ü§ñ",
    layout="wide",
    initial_sidebar_state="collapsed"
)

# Custom CSS for styling
st.markdown("""
<style>
    .main-header {
        background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
        padding: 2rem;
        border-radius: 20px;
        color: white;
        text-align: center;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    .bot-message {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        padding: 1rem 1.5rem;
        border-radius: 18px;
        margin: 1rem 0;
        border-left: 4px solid #667eea;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .user-message {
        background: linear-gradient(135deg, #667eea, #764ba2);
        padding: 1rem 1.5rem;
        border-radius: 18px;
        margin: 1rem 0;
        color: white;
        margin-left: 2rem;
        box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
    }
    
    .option-button {
        background: linear-gradient(135deg, #e3f2fd, #bbdefb);
        border: 2px solid #2196f3;
        padding: 12px 24px;
        border-radius: 25px;
        margin: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
        color: #1976d2;
        font-size: 16px;
        display: inline-block;
        text-decoration: none;
        box-shadow: 0 4px 8px rgba(33, 150, 243, 0.2);
    }
    
    .option-button:hover {
        background: linear-gradient(135deg, #2196f3, #1976d2);
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(33, 150, 243, 0.4);
    }
    
    .quick-action {
        background: linear-gradient(135deg, #ecf0f1, #bdc3c7);
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 25px;
        margin: 0.25rem;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
    }
    
    .quick-action:hover {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        transform: translateY(-2px);
    }
    
    .stTextInput > div > div > input {
        border-radius: 25px;
        padding: 1rem;
        border: 2px solid #e0e0e0;
        font-size: 1rem;
    }
    
    .stTextInput > div > div > input:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .stButton > button {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border: none;
        border-radius: 25px;
        padding: 0.75rem 2rem;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
    }
    
    .stButton > button:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(102, 126, 234, 0.4);
    }
    
    body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .block-container {
        padding-top: 2rem;
        padding-bottom: 2rem;
    }
    
    .choice-container {
        background: rgba(255, 255, 255, 0.1);
        padding: 1rem;
        border-radius: 15px;
        margin: 1rem 0;
        backdrop-filter: blur(10px);
    }
</style>
""", unsafe_allow_html=True)

# Employee Handbook Data
HANDBOOK_DATA = {
    'leave': {
        'title': 'Annual Leave Policy',
        'content': """üìÖ **Annual Leave Entitlement:**

‚Ä¢ **First Year:** 20 working days (after probation completion)
‚Ä¢ **Subsequent Years:** 22 working days from second year onward
‚Ä¢ **Notice Required:** Minimum twice the duration of leave requested
‚Ä¢ **Peak Periods:** July and August may have restrictions

**How to Apply:**
1. Submit Annual Leave Form to Line Manager
2. First-come, first-served basis
3. Subject to operational requirements

**Carry Over Rules:**
‚Ä¢ Administrative Staff: Maximum 7 days per year
‚Ä¢ Teaching Staff: Not permitted to carry over

üìã **Reference:** Section 9.2 of Employee Handbook"""
    },
    
    'sick': {
        'title': 'Sick Leave Policy',
        'content': """üè• **Sick Leave Entitlement (per year):**

‚Ä¢ **Total:** 90 calendar days after 3 months post-probation
‚Ä¢ **Full Pay:** First 15 calendar days
‚Ä¢ **Half Pay:** Next 30 calendar days
‚Ä¢ **No Pay:** Next 45 days

**Application Process:**
‚Ä¢ Notify manager within 1.5 hours (academic) or 1 hour (admin)
‚Ä¢ Complete Sick Leave Form upon return
‚Ä¢ Medical certificate required for absence beyond 2 days

‚ö†Ô∏è **Important:** Available only after completing probationary period

üìã **Reference:** Section 9.3 of Employee Handbook"""
    },
    
    'working hours': {
        'title': 'Working Hours',
        'content': """‚è∞ **Working Hours:**

**Administrative Staff:**
‚Ä¢ Days: Monday ‚Äì Friday
‚Ä¢ Hours: 9:00am ‚Äì 6:00pm
‚Ä¢ Overtime: Paid at management's discretion

**Academic Staff:**
‚Ä¢ Days: Monday to Friday
‚Ä¢ Sessions: 9am-12pm, 12pm-3pm, 3pm-6pm
‚Ä¢ Minimum: 2 sessions per day
‚Ä¢ Flexible scheduling based on demand

**Ramadan Hours:**
‚Ä¢ 2 hours reduction per day (if normal hours exceed 8 hours)
‚Ä¢ 1 week notice for revised times
‚Ä¢ Applies to administrative staff only

üìã **Reference:** Section 5 of Employee Handbook"""
    },
    
    'benefits': {
        'title': 'Employee Benefits',
        'content': """üéÅ **Comprehensive Benefits Package:**

**Health Insurance:**
‚Ä¢ Basic Cover: First 6 months (probation)
‚Ä¢ Comprehensive Cover: After 6 months

**Visa Sponsorship:**
‚Ä¢ Company-sponsored resident visa
‚Ä¢ Dependent visas available (employee covers costs)

**Leave Benefits:**
‚Ä¢ Annual Leave: 20-22 days
‚Ä¢ Sick Leave: Up to 90 days
‚Ä¢ Maternity: 60 days (45 full pay + 15 half pay)
‚Ä¢ Parental: 5 days (male/female)
‚Ä¢ Bereavement: 3-5 days

**National Holidays:**
‚Ä¢ New Year's Day ‚Ä¢ Eid Al Fitr (2 days) ‚Ä¢ Eid Al Adha (3 days)
‚Ä¢ Prophet's Birthday ‚Ä¢ National Day ‚Ä¢ Isra & Al Miraj

üìã **Reference:** Section 9 of Employee Handbook"""
    },
    
    'conduct': {
        'title': 'Code of Conduct',
        'content': """üëî **Professional Standards:**

**Employee Duties:**
‚Ä¢ Create culture of mutual respect
‚Ä¢ Exercise reasonable skill and care
‚Ä¢ Maintain confidentiality
‚Ä¢ Professional language at all times
‚Ä¢ Healthy work-life balance

**Dress Code:**
‚Ä¢ Smart, professional attire
‚Ä¢ Clean, tidy, and appropriate clothing
‚Ä¢ Cover tattoos where possible
‚Ä¢ No torn, transparent, or inappropriate clothing
‚Ä¢ Religious dress permitted unless safety risk

**Safeguarding (Students):**
‚Ä¢ No physical contact with students
‚Ä¢ Avoid being alone with students
‚Ä¢ Maintain professional boundaries
‚Ä¢ No personal relationships
‚Ä¢ Report any concerns to management

üìã **Reference:** Section 6 of Employee Handbook"""
    },
    
    'disciplinary': {
        'title': 'Disciplinary Procedures',
        'content': """‚öñÔ∏è **Disciplinary Process:**

**Warning System:**
‚Ä¢ Verbal Warning: 6 months validity
‚Ä¢ First Written: 12 months validity
‚Ä¢ Final Written: 12 months validity

**Minor Misconduct Examples:**
‚Ä¢ Persistent lateness ‚Ä¢ Unauthorized absence
‚Ä¢ Failure to follow procedures ‚Ä¢ Private work during hours

**Gross Misconduct Examples:**
‚Ä¢ Theft of company property ‚Ä¢ Breach of confidentiality
‚Ä¢ Being unfit for duty ‚Ä¢ Safeguarding violations
‚Ä¢ Discrimination/harassment ‚Ä¢ Bringing company into disrepute

**Process:**
1. Formal investigation by HR
2. Written notification of hearing
3. Disciplinary hearing with representation
4. Decision communicated in writing
5. Right to appeal within 5 days

üìã **Reference:** Section 12 of Employee Handbook"""
    },
    
    'covid': {
        'title': 'COVID-19 Policy',
        'content': """ü¶† **COVID-19 Guidelines:**

**If Showing Symptoms:**
‚Ä¢ Immediate isolation and hospital referral
‚Ä¢ Cannot return until PCR result obtained
‚Ä¢ 7-day quarantine for close contacts

**Vaccination Requirements:**
‚Ä¢ Proof of vaccination required
‚Ä¢ Weekly PCR tests if unvaccinated
‚Ä¢ Medical exemptions with doctor's certificate

**Workplace Protocols:**
‚Ä¢ Regular sanitization
‚Ä¢ Social distancing measures
‚Ä¢ Online teaching capabilities for quarantine

üìã **Reference:** Section 10 of Employee Handbook"""
    },
    
    'termination': {
        'title': 'Termination & Gratuity',
        'content': """üìã **End of Service:**

**Notice Periods:**
‚Ä¢ Limited Contract: No notice (expires at end date)
‚Ä¢ Unlimited Contract: Minimum 30 calendar days

**Gratuity Calculation:**
‚Ä¢ 21 days basic pay for each of first 5 years
‚Ä¢ 30 days basic pay for each additional year
‚Ä¢ Maximum: 2 years' total pay

**Early Termination:**
‚Ä¢ Employer: 3 months' compensation
‚Ä¢ Employee: Half of 3 months' compensation

**Resignation Gratuity (Unlimited Contract):**
‚Ä¢ 1-3 years: 2/3 reduction
‚Ä¢ 3-5 years: 1/3 reduction
‚Ä¢ 5+ years: No reduction

üìã **Reference:** Section 18 of Employee Handbook"""
    },
    
    # New sub-category entries
    'health insurance': {
        'title': 'Health Insurance Coverage',
        'content': """üè• **Health Insurance Policy:**

**Coverage Levels:**
‚Ä¢ **Probation Period:** Basic medical coverage (first 6 months)
‚Ä¢ **After 6 Months:** Comprehensive medical coverage
‚Ä¢ **Dependents:** Available upon request (employee covers costs)

**What's Covered:**
‚Ä¢ Medical consultations and treatments
‚Ä¢ Emergency medical services
‚Ä¢ Prescription medications
‚Ä¢ Specialist referrals

**Important Notes:**
‚Ä¢ Coverage begins after probation completion
‚Ä¢ Employee responsible for dependent insurance costs
‚Ä¢ Processing fees apply for dependent coverage

üìã **Reference:** Section 9 of Employee Handbook"""
    },
    
    'visa sponsorship': {
        'title': 'Visa & Immigration Support',
        'content': """üìã **Visa Sponsorship Policy:**

**Employee Visa:**
‚Ä¢ Company-sponsored resident visa provided
‚Ä¢ All visa processing handled by company
‚Ä¢ Valid for duration of employment

**Dependent Visas:**
‚Ä¢ Available upon request and line manager agreement
‚Ä¢ Employee covers ALL dependent costs including:
  - Processing fees
  - Visa application fees  
  - Medical insurance for dependents
  - Emirates ID fees

**Application Process:**
‚Ä¢ Submit request to line manager
‚Ä¢ Provide required documentation
‚Ä¢ Company assists with processing

üìã **Reference:** Section 9 of Employee Handbook"""
    },
    
    'national holidays': {
        'title': 'National Holidays & Public Days Off',
        'content': """üéÜ **Official National Holidays:**

**Religious Holidays:**
‚Ä¢ Hijiri's New Year's Day (1 day)
‚Ä¢ Eid Al Fitr (2 days)
‚Ä¢ Eid Al Adha (3 days)
‚Ä¢ Prophet Mohammed's Birthday (1 day)
‚Ä¢ Isra and Al Miraj (1 day)

**National Celebrations:**
‚Ä¢ Gregorian New Year's Day (1 day)
‚Ä¢ UAE National Day (1 day)

**Total:** 9 official national holidays per year

**Important Notes:**
‚Ä¢ Holidays are paid time off
‚Ä¢ Dates may vary based on lunar calendar
‚Ä¢ Official announcements will be made
‚Ä¢ No work required on these days

üìã **Reference:** Section 9 of Employee Handbook"""
    },
    
    'administrative hours': {
        'title': 'Administrative Staff Working Hours',
        'content': """üíº **Administrative Staff Schedule:**

**Regular Hours:**
‚Ä¢ **Days:** Monday ‚Äì Friday
‚Ä¢ **Time:** 9:00am ‚Äì 6:00pm
‚Ä¢ **Break:** Standard lunch break included

**Overtime:**
‚Ä¢ Paid in accordance to confirmed attendance
‚Ä¢ At management's discretion
‚Ä¢ Must be pre-approved

**Ramadan Schedule:**
‚Ä¢ 2 hours reduction per day (if normal hours exceed 8 hours)
‚Ä¢ 1 week notice provided for revised times
‚Ä¢ Applies to administrative staff only

**Attendance:**
‚Ä¢ Punctuality expected
‚Ä¢ Notify manager of any delays
‚Ä¢ Consistent lateness may result in disciplinary action

üìã **Reference:** Section 5 of Employee Handbook"""
    },
    
    'academic hours': {
        'title': 'Academic Staff Teaching Schedule',
        'content': """üè´ **Academic Staff Schedule:**

**Teaching Sessions:**
‚Ä¢ **Morning:** 9:00am ‚Äì 12:00pm
‚Ä¢ **Afternoon:** 12:00pm ‚Äì 3:00pm  
‚Ä¢ **Evening:** 3:00pm ‚Äì 6:00pm

**Requirements:**
‚Ä¢ **Minimum:** 2 sessions per day
‚Ä¢ **Days:** Monday to Friday
‚Ä¢ **Flexibility:** Can work additional sessions based on demand

**Schedule Variations:**
‚Ä¢ Can work 3rd session during busy periods (overtime)
‚Ä¢ May reduce to 1 session during quieter periods
‚Ä¢ Schedule adjustments based on student enrollment

**Ramadan:**
‚Ä¢ No special hour reductions for teaching staff
‚Ä¢ Maintain regular session schedule

üìã **Reference:** Section 5 of Employee Handbook"""
    },
    
    'dress code': {
        'title': 'Professional Dress Code Standards',
        'content': """üëî **Dress Code Policy:**

**Required Standards:**
‚Ä¢ Smart, professional attire
‚Ä¢ Clean, tidy, and appropriate clothing
‚Ä¢ Professional appearance at all times

**Prohibited Items:**
‚Ä¢ Torn, dirty, or worn clothing/footwear
‚Ä¢ Transparent clothing revealing underwear or midriffs
‚Ä¢ Low-cut necklines
‚Ä¢ Very short skirts or trousers
‚Ä¢ Shorts or beachwear
‚Ä¢ Flip-flops

**Personal Appearance:**
‚Ä¢ **Tattoos:** Should be covered where possible
‚Ä¢ **Piercings:** Only earrings or nose studs permitted
‚Ä¢ **Religious dress:** Appropriate cultural dress permitted unless safety risk

**Compliance:**
‚Ä¢ Managers may address dress code violations
‚Ä¢ Repeated violations may result in disciplinary action

üìã **Reference:** Section 6 of Employee Handbook"""
    },
    
    'safeguarding rules': {
        'title': 'Student Safeguarding Guidelines',
        'content': """üõë **Student Safeguarding Policy:**

**Physical Contact:**
‚Ä¢ **No physical contact** with students
‚Ä¢ Maintain professional distance at all times
‚Ä¢ Avoid situations that could be misinterpreted

**Interaction Guidelines:**
‚Ä¢ Avoid being alone with students
‚Ä¢ Keep classroom doors open
‚Ä¢ Maintain respectable distance
‚Ä¢ No personal conversations with students
‚Ä¢ No advice about personal relationships

**Teaching Environment:**
‚Ä¢ No teaching small groups without another staff member present
‚Ä¢ Be aware of student attachments and maintain distance
‚Ä¢ Report any concerning behavior to management

**Outside Contact:**
‚Ä¢ **No contact outside school**
‚Ä¢ No personal contact details to students
‚Ä¢ No social media following (except official ES forums)
‚Ä¢ No private meetings outside school
‚Ä¢ No vehicle lifts without permission
‚Ä¢ No private parties or social events
‚Ä¢ **No romantic or sexual relationships with students**

**Violations:**
‚Ä¢ Safeguarding violations are considered **gross misconduct**
‚Ä¢ May result in immediate termination

üìã **Reference:** Section 6 of Employee Handbook"""
    },
    
    'minor misconduct': {
        'title': 'Minor Misconduct Examples & Consequences',
        'content': """‚ö†Ô∏è **Minor Misconduct Categories:**

**Attendance Issues:**
‚Ä¢ Persistent lateness and poor timekeeping
‚Ä¢ Unauthorized absence without valid reason
‚Ä¢ Abuse of sick leave policies

**Work Performance:**
‚Ä¢ Incompetence in job duties
‚Ä¢ Failure to follow prescribed procedures
‚Ä¢ Failure to observe company regulations
‚Ä¢ Private work during working hours

**Typical Consequences:**
‚Ä¢ **First Offense:** Verbal warning (6 months validity)
‚Ä¢ **Repeated Issues:** First written warning (12 months validity)
‚Ä¢ **Continued Problems:** Final written warning (12 months validity)
‚Ä¢ **Persistent Issues:** Possible termination

**Progressive Discipline:**
‚Ä¢ Warnings build upon each other
‚Ä¢ Each step gives opportunity for improvement
‚Ä¢ Support and training may be provided
‚Ä¢ Right to appeal at each stage

üìã **Reference:** Section 12 of Employee Handbook"""
    },
    
    'gross misconduct': {
        'title': 'Gross Misconduct & Immediate Consequences',
        'content': """üö® **Serious Violations (Gross Misconduct):**

**Criminal/Illegal Acts:**
‚Ä¢ Theft or unauthorized possession of company property
‚Ä¢ Bribery, corruption, or illegal activities
‚Ä¢ Physical assault or threats of violence

**Professional Violations:**
‚Ä¢ Breaches of confidentiality or security
‚Ä¢ Being unfit for duty due to drugs/alcohol
‚Ä¢ False declaration of qualifications
‚Ä¢ Failure to observe safeguarding rules

**Workplace Behavior:**
‚Ä¢ Refusal to carry out management instructions
‚Ä¢ Insulting behavior/insubordination
‚Ä¢ Unlawful discrimination, bullying, or harassment
‚Ä¢ Bringing organization into serious disrepute
‚Ä¢ Willful damage of company property
‚Ä¢ Intimidation of colleagues or students

**Technology Misuse:**
‚Ä¢ Accessing pornographic/offensive material
‚Ä¢ Serious misuse of company IT systems

**Immediate Consequences:**
‚Ä¢ **May result in immediate termination**
‚Ä¢ No progressive warnings required
‚Ä¢ Summary dismissal possible
‚Ä¢ Right to formal hearing and appeal

üìã **Reference:** Section 12 of Employee Handbook"""
    },
    
    'performance appraisal': {
        'title': 'Performance Appraisal Process',
        'content': """üìä **Annual Performance Review:**

**Schedule:**
‚Ä¢ **First Review:** After 6-month probation completion
‚Ä¢ **Ongoing:** Annual formal reviews thereafter
‚Ä¢ **Mid-Year:** Optional 6-month verbal review
‚Ä¢ **Notice:** At least 1 week before meeting

**Review Process:**
‚Ä¢ Performance evaluation forms provided in advance
‚Ä¢ Employee self-assessment encouraged
‚Ä¢ Meeting with line manager or senior staff
‚Ä¢ Discussion of achievements and areas for improvement
‚Ä¢ Goal setting for upcoming period

**Confidentiality:**
‚Ä¢ Information shared only with senior management
‚Ä¢ Private and confidential process
‚Ä¢ Professional development focus

**Outcomes:**
‚Ä¢ Performance rating
‚Ä¢ Development plan
‚Ä¢ Training recommendations
‚Ä¢ Career progression discussions
‚Ä¢ Salary review considerations

**Documentation:**
‚Ä¢ Written record of review
‚Ä¢ Signed by both parties
‚Ä¢ Filed in personnel records

üìã **Reference:** Section 11 of Employee Handbook"""
    },
    
    'maternity leave': {
        'title': 'Maternity Leave Policy',
        'content': """ü§± **Maternity Leave Entitlement:**

**Total Leave:** 60 days
‚Ä¢ **Full Pay:** First 45 consecutive calendar days
‚Ä¢ **Half Pay:** Following 15 days

**Application Requirements:**
‚Ä¢ **Notice:** 15 weeks before due date
‚Ä¢ **Documentation:** Medical certificate required
‚Ä¢ **Planning:** Coordinate with line manager

**Additional Benefits:**
‚Ä¢ **Feeding Breaks:** Two additional 30-minute breaks each day
‚Ä¢ **Duration:** Available for 18 months post-delivery
‚Ä¢ **Extended Leave:** Up to 100 additional days without pay (consecutive or non-consecutive)

**Return to Work:**
‚Ä¢ Medical clearance required
‚Ä¢ Gradual return options available
‚Ä¢ Job protection during leave period

**Important Notes:**
‚Ä¢ Leave cannot be carried over
‚Ä¢ Available to all female employees
‚Ä¢ Coordinate with HR for smooth transition

üìã **Reference:** Section 9.4 of Employee Handbook"""
    },
    
    'parental leave': {
        'title': 'Parental Leave Policy',
        'content': """üë∂ **Parental Leave Entitlement:**

**For All New Parents:**
‚Ä¢ **Female Employees:** 5 paid days
‚Ä¢ **Male Employees:** 5 paid days
‚Ä¢ **Time Frame:** Must be taken within 6 months of birth

**Application Process:**
‚Ä¢ Submit request to line manager
‚Ä¢ Provide birth certificate/documentation
‚Ä¢ Can be taken consecutively or separately
‚Ä¢ Advance notice preferred

**Purpose:**
‚Ä¢ Support new parent bonding
‚Ä¢ Assist with family adjustment
‚Ä¢ Cover immediate post-birth needs
‚Ä¢ Complement maternity leave for mothers

**Coverage:**
‚Ä¢ Full salary maintained
‚Ä¢ No impact on annual leave entitlement
‚Ä¢ Job protection guaranteed
‚Ä¢ Available for adoptions as well

**Coordination:**
‚Ä¢ Work with team to cover responsibilities
‚Ä¢ Plan ahead for smooth workflow
‚Ä¢ Support available from management

üìã **Reference:** Section 9.5 of Employee Handbook"""
    },
    
    'bereavement leave': {
        'title': 'Bereavement Leave Policy',
        'content': """üïä **Bereavement Leave Entitlement:**

**Spouse/Partner:**
‚Ä¢ **5 paid days** for loss of spouse or life partner
‚Ä¢ Can be taken consecutively or as needed
‚Ä¢ Additional unpaid leave may be granted

**Immediate Family:**
‚Ä¢ **3 paid days** for loss of:
  - Parent or step-parent
  - Child or step-child
  - Sibling
  - Grandchild
  - Grandparent

**Application Process:**
‚Ä¢ Notify line manager as soon as possible
‚Ä¢ No formal application required initially
‚Ä¢ Documentation may be requested later
‚Ä¢ Flexible timing based on funeral arrangements

**Additional Support:**
‚Ä¢ Extended unpaid leave available if needed
‚Ä¢ Flexible working arrangements during grief period
‚Ä¢ Employee assistance program access
‚Ä¢ Counseling support available

**Important:**
‚Ä¢ Full salary maintained during paid leave
‚Ä¢ No impact on other leave entitlements
‚Ä¢ Cultural and religious considerations respected
‚Ä¢ Management support available

üìã **Reference:** Section 9.6 of Employee Handbook"""
    }
}

# Initialize session state
if 'messages' not in st.session_state:
    st.session_state.messages = []
    welcome_response = {
        'type': 'content',
        'content': 'üëã Hello! I am your **LGL Employee Helper**. Ask me anything about the Alistar Personnel Employee Handbook!\n\nI can help you with policies, procedures, benefits, and much more. What would you like to know?'
    }
    st.session_state.messages.append({
        'role': 'assistant',
        'content': welcome_response['content'],
        'response_data': welcome_response
    })

# Initialize input tracking to prevent loops
if 'last_input' not in st.session_state:
    st.session_state.last_input = ""
if 'processing' not in st.session_state:
    st.session_state.processing = False

def process_user_question(question):
    """Process user question and return appropriate response"""
    question_lower = question.lower().strip()
    
    # Define intuitive keyword mappings - more flexible matching
    keyword_mappings = {
        'annual_leave': {
            'keywords': ['annual leave', 'vacation', 'holiday', 'time off', 'days off', 'annual', 'holidays', 'vacations'],
            'icon': 'üèñÔ∏è',
            'title': 'Annual Leave'
        },
        'sick_leave': {
            'keywords': ['sick leave', 'medical leave', 'illness', 'doctor', 'health leave', 'medical', 'ill', 'sickness', 'sick'],
            'icon': 'üè•',
            'title': 'Sick Leave'
        },
        'working_hours': {
            'keywords': ['working hours', 'work time', 'schedule', 'shifts', 'office hours', 'hours', 'time', 'work schedule', 'working time'],
            'icon': '‚è∞',
            'title': 'Working Hours'
        },
        'benefits': {
            'keywords': ['benefits', 'insurance', 'health insurance', 'visa', 'perks', 'benefit', 'health', 'medical insurance'],
            'icon': 'üéÅ',
            'title': 'Employee Benefits'
        },
        'conduct': {
            'keywords': ['conduct', 'behavior', 'dress code', 'professional', 'standards', 'behaviour', 'dress', 'code', 'professional standards'],
            'icon': 'üëî',
            'title': 'Code of Conduct'
        },
        'disciplinary': {
            'keywords': ['disciplinary', 'warning', 'misconduct', 'punishment', 'violation', 'discipline', 'warnings', 'disciplinary action'],
            'icon': '‚öñÔ∏è',
            'title': 'Disciplinary Procedures'
        },
        'covid': {
            'keywords': ['covid', 'coronavirus', 'quarantine', 'vaccination', 'pandemic', 'covid-19', 'virus', 'vaccine'],
            'icon': 'ü¶†',
            'title': 'COVID-19 Policy'
        },
        'termination': {
            'keywords': ['termination', 'resignation', 'gratuity', 'end of service', 'quit', 'resign', 'leaving', 'end service', 'terminate'],
            'icon': 'üìã',
            'title': 'Termination & Gratuity'
        },
        # New sub-category mappings
        'health_insurance': {
            'keywords': ['health insurance', 'medical insurance', 'medical coverage', 'health coverage', 'insurance policy'],
            'icon': 'üè•',
            'title': 'Health Insurance'
        },
        'visa_sponsorship': {
            'keywords': ['visa sponsorship', 'work visa', 'resident visa', 'visa support', 'immigration'],
            'icon': 'üìã',
            'title': 'Visa Sponsorship'
        },
        'national_holidays': {
            'keywords': ['national holidays', 'public holidays', 'official holidays', 'eid', 'national day'],
            'icon': 'üéÜ',
            'title': 'National Holidays'
        },
        'administrative_hours': {
            'keywords': ['administrative hours', 'admin hours', 'office hours', 'admin schedule'],
            'icon': 'üíº',
            'title': 'Administrative Hours'
        },
        'academic_hours': {
            'keywords': ['academic hours', 'teaching hours', 'teaching schedule', 'sessions', 'academic schedule'],
            'icon': 'üè´',
            'title': 'Academic Hours'
        },
        'dress_code': {
            'keywords': ['dress code', 'attire', 'clothing', 'appearance', 'professional dress'],
            'icon': 'üëî',
            'title': 'Dress Code'
        },
        'safeguarding_rules': {
            'keywords': ['safeguarding', 'student safety', 'protection', 'safeguarding rules'],
            'icon': 'üõë',
            'title': 'Safeguarding Rules'
        },
        'minor_misconduct': {
            'keywords': ['minor misconduct', 'minor violations', 'lateness', 'attendance issues'],
            'icon': '‚ö†Ô∏è',
            'title': 'Minor Misconduct'
        },
        'gross_misconduct': {
            'keywords': ['gross misconduct', 'serious violations', 'theft', 'harassment', 'immediate termination'],
            'icon': 'üö®',
            'title': 'Gross Misconduct'
        },
        'performance_appraisal': {
            'keywords': ['performance appraisal', 'performance review', 'annual review', 'evaluation'],
            'icon': 'üìä',
            'title': 'Performance Appraisal'
        },
        'maternity_leave': {
            'keywords': ['maternity leave', 'maternity', 'pregnancy leave', 'maternity policy'],
            'icon': 'ü§±',
            'title': 'Maternity Leave'
        },
        'parental_leave': {
            'keywords': ['parental leave', 'paternity leave', 'new parent leave'],
            'icon': 'üë∂',
            'title': 'Parental Leave'
        },
        'bereavement_leave': {
            'keywords': ['bereavement leave', 'bereavement', 'family death', 'funeral leave'],
            'icon': 'üïä',
            'title': 'Bereavement Leave'
        }
    }
    
    # Handle specific queries that might be confusing
    special_cases = {
        'interview': 'recruitment',
        'hiring': 'recruitment', 
        'job application': 'recruitment',
        'salary': 'benefits',
        'pay': 'benefits',
        'money': 'benefits',
        'promotion': 'performance',
        'review': 'performance',
        'evaluation': 'performance'
    }
    
    # Check for special cases first
    for special_word, redirect_topic in special_cases.items():
        if special_word in question_lower:
            if redirect_topic == 'recruitment':
                return {
                    'type': 'content',
                    'content': f"""üîç I understand you're asking about **{special_word}**, but I specialize in providing information about current employee policies from the Alistar Personnel Employee Handbook.

üìß **For recruitment, hiring, and job applications, please contact:**
üè¢ **HR Department** at Alistar Personnel
üìç **Location:** 605, Park Avenue , Dubai Silicon Oasis

‚ú® **I can help current employees with:**
‚Ä¢ üèñÔ∏è Annual Leave policies
‚Ä¢ ‚è∞ Working hours and schedules  
‚Ä¢ üéÅ Employee benefits
‚Ä¢ üëî Code of conduct
‚Ä¢ üìä Performance management
‚Ä¢ And much more!

*Have a great day! I am always here to guide you. Do you want to know more?* üòä"""
                }
            elif redirect_topic == 'benefits':
                data = HANDBOOK_DATA['benefits']
                return {
                    'type': 'content',
                    'content': f"üéÅ **{data['title']}**\n\n{data['content']}\n\n*Have a great day! I am always here to guide you. Do you want to know more?* üòä"
                }
    
    # Check for ambiguous 'leave' query - show options
    if question_lower in ['leave', 'leaves'] or (len(question_lower.split()) == 1 and 'leave' in question_lower):
        return {
            'type': 'options',
            'content': """ü§î I see you're asking about **leave** policies. There are different types of leave available:

**Please choose which type of leave you'd like to know about:**""",
            'options': [
                {'text': 'üèñÔ∏è Annual Leave', 'value': 'annual leave', 'description': 'Vacation days, holidays, and time off'},
                {'text': 'üè• Sick Leave', 'value': 'sick leave', 'description': 'Medical leave policies and procedures'},
                {'text': 'ü§± Maternity Leave', 'value': 'maternity leave', 'description': 'Maternity leave policies and procedures'},
                {'text': 'üë∂ Parental Leave', 'value': 'parental leave', 'description': 'Parental leave for new parents'},
                {'text': 'üïä Bereavement Leave', 'value': 'bereavement leave', 'description': 'Leave for family bereavement'}
            ],
            'footer': "üí° **Tip:** You can also ask more specifically like 'annual leave' or 'sick leave' for direct answers!\n\n*Have a great day! I am always here to guide you. Do you want to know more?* üòä"
        }
    
    # Check for ambiguous 'benefits' query - show options
    if question_lower in ['benefits', 'benefit'] or (len(question_lower.split()) == 1 and any(word in question_lower for word in ['insurance', 'visa', 'perks'])):
        return {
            'type': 'options',
            'content': """üéÅ I see you're asking about **employee benefits**. We offer several types of benefits:

**Please choose which benefit you'd like to know about:**""",
            'options': [
                {'text': 'üè• Health Insurance', 'value': 'health insurance', 'description': 'Medical insurance coverage and policies'},
                {'text': 'üìã Visa Sponsorship', 'value': 'visa sponsorship', 'description': 'Work visa and dependent visa policies'},
                {'text': 'üèñÔ∏è Leave Benefits', 'value': 'leave benefits', 'description': 'All types of leave policies'},
                {'text': 'üéÜ National Holidays', 'value': 'national holidays', 'description': 'Official holidays and public days off'}
            ],
            'footer': "üí° **Tip:** You can also ask specifically about 'health insurance' or 'visa' for direct answers!\n\n*Have a great day! I am always here to guide you. Do you want to know more?* üòä"
        }
    
    # Check for ambiguous 'working hours' or 'hours' query - show options
    if question_lower in ['hours', 'working hours', 'schedule', 'shifts'] or (len(question_lower.split()) <= 2 and any(word in question_lower for word in ['working', 'office', 'schedule'])):
        return {
            'type': 'options',
            'content': """‚è∞ I see you're asking about **working hours**. We have different schedules for different staff:

**Please choose which schedule you'd like to know about:**""",
            'options': [
                {'text': 'üíº Administrative Hours', 'value': 'administrative hours', 'description': 'Office hours for administrative staff'},
                {'text': 'üè´ Academic Hours', 'value': 'academic hours', 'description': 'Teaching schedule for academic staff'},
                {'text': 'üï∞Ô∏è Overtime Policy', 'value': 'overtime policy', 'description': 'Overtime rules and compensation'},
                {'text': 'üåô Ramadan Hours', 'value': 'ramadan hours', 'description': 'Special working hours during Ramadan'}
            ],
            'footer': "üí° **Tip:** You can also ask specifically about 'admin hours' or 'academic schedule' for direct answers!\n\n*Have a great day! I am always here to guide you. Do you want to know more?* üòä"
        }
    
    # Check for ambiguous 'conduct' or 'code' query - show options
    if question_lower in ['conduct', 'code', 'behavior', 'behaviour'] or (len(question_lower.split()) <= 2 and any(word in question_lower for word in ['dress', 'professional', 'standards'])):
        return {
            'type': 'options',
            'content': """üëî I see you're asking about **code of conduct**. There are several important areas:

**Please choose which aspect you'd like to know about:**""",
            'options': [
                {'text': 'üëî Dress Code', 'value': 'dress code', 'description': 'Professional attire and appearance standards'},
                {'text': 'üõë Safeguarding Rules', 'value': 'safeguarding rules', 'description': 'Student protection and safety guidelines'},
                {'text': 'üíº Professional Standards', 'value': 'professional standards', 'description': 'Employee duties and workplace behavior'},
                {'text': 'ü§ù Workplace Behavior', 'value': 'workplace behavior', 'description': 'General conduct and interaction guidelines'}
            ],
            'footer': "üí° **Tip:** You can also ask specifically about 'dress code' or 'safeguarding' for direct answers!\n\n*Have a great day! I am always here to guide you. Do you want to know more?* üòä"
        }
    
    # Check for ambiguous 'disciplinary' query - show options  
    if question_lower in ['disciplinary', 'discipline', 'warning', 'misconduct'] or (len(question_lower.split()) <= 2 and any(word in question_lower for word in ['punishment', 'violation', 'warnings'])):
        return {
            'type': 'options',
            'content': """‚öñÔ∏è I see you're asking about **disciplinary procedures**. There are different aspects to understand:

**Please choose which area you'd like to know about:**""",
            'options': [
                {'text': '‚ö†Ô∏è Minor Misconduct', 'value': 'minor misconduct', 'description': 'Examples and consequences of minor violations'},
                {'text': 'üö® Gross Misconduct', 'value': 'gross misconduct', 'description': 'Serious violations and immediate consequences'},
                {'text': 'üìã Warning System', 'value': 'warning system', 'description': 'Types of warnings and their validity periods'},
                {'text': '‚öñÔ∏è Disciplinary Process', 'value': 'disciplinary process', 'description': 'Step-by-step procedure and appeal rights'}
            ],
            'footer': "üí° **Tip:** You can also ask specifically about 'gross misconduct' or 'warnings' for direct answers!\n\n*Have a great day! I am always here to guide you. Do you want to know more?* üòä"
        }
    
    # Check for ambiguous 'performance' query - show options
    if question_lower in ['performance', 'review', 'appraisal', 'evaluation'] or (len(question_lower.split()) <= 2 and any(word in question_lower for word in ['probation', 'assessment'])):
        return {
            'type': 'options',
            'content': """üìä I see you're asking about **performance management**. There are key areas to understand:

**Please choose which aspect you'd like to know about:**""",
            'options': [
                {'text': 'üìä Performance Appraisal', 'value': 'performance appraisal', 'description': 'Annual review process and procedures'},
                {'text': '‚è≥ Probation Period', 'value': 'probation period', 'description': 'Probationary period requirements and review'},
                {'text': 'üìÖ Review Schedule', 'value': 'review schedule', 'description': 'When and how often reviews take place'},
                {'text': 'üìù Performance Standards', 'value': 'performance standards', 'description': 'Expected standards and evaluation criteria'}
            ],
            'footer': "üí° **Tip:** You can also ask specifically about 'probation' or 'appraisal' for direct answers!\n\n*Have a great day! I am always here to guide you. Do you want to know more?* üòä"
        }
    
    # Check for topic matches with scoring
    matches = []
    for topic_key, topic_data in keyword_mappings.items():
        score = 0
        for keyword in topic_data['keywords']:
            if keyword in question_lower:
                if keyword == question_lower:
                    score += 10  # Exact match
                else:
                    score += len(keyword)  # Partial match
        
        if score > 0:
            matches.append((topic_key, score, topic_data))
    
    # Sort matches by score
    matches.sort(key=lambda x: x[1], reverse=True)
    
    # If we found a clear best match
    if matches and matches[0][1] > 0:
        best_match = matches[0][0]
        # Map to HANDBOOK_DATA keys
        handbook_key_mapping = {
            'annual_leave': 'leave',
            'sick_leave': 'sick',
            'working_hours': 'working hours',
            'benefits': 'benefits',
            'conduct': 'conduct',
            'disciplinary': 'disciplinary',
            'covid': 'covid',
            'termination': 'termination',
            # New sub-category mappings
            'health_insurance': 'health insurance',
            'visa_sponsorship': 'visa sponsorship',
            'national_holidays': 'national holidays',
            'administrative_hours': 'administrative hours',
            'academic_hours': 'academic hours',
            'dress_code': 'dress code',
            'safeguarding_rules': 'safeguarding rules',
            'minor_misconduct': 'minor misconduct',
            'gross_misconduct': 'gross misconduct',
            'performance_appraisal': 'performance appraisal',
            'maternity_leave': 'maternity leave',
            'parental_leave': 'parental leave',
            'bereavement_leave': 'bereavement leave'
        }
        
        if best_match in handbook_key_mapping and handbook_key_mapping[best_match] in HANDBOOK_DATA:
            data = HANDBOOK_DATA[handbook_key_mapping[best_match]]
            icon = matches[0][2]['icon']
            return {
                'type': 'content',
                'content': f"{icon} **{data['title']}**\n\n{data['content']}\n\n*Have a great day! I am always here to guide you. Do you want to know more?* üòä"
            }
    
    # Check for greeting or general questions
    greetings = ['hello', 'hi', 'hey', 'good morning', 'good afternoon', 'thank you', 'thanks']
    if any(greeting in question_lower for greeting in greetings):
        return {
            'type': 'content',
            'content': """üëã Hello! I am your **LGL Employee Helper**. I'm here to help you with any questions about the Alistar Personnel Employee Handbook.

‚ú® I can assist you with policies, procedures, benefits, and much more. What would you like to know?

*Have a great day! I am always here to guide you. Do you want to know more?* üòä"""
        }
    
    # Default response for unrecognized questions
    return {
        'type': 'options',
        'content': f"ü§î I understand you asked about '{question}', but I couldn't find specific information about that topic in the Employee Handbook.",
        'options': [
            {'text': 'üèñÔ∏è Annual Leave', 'value': 'annual leave', 'description': 'Vacation days and application process'},
            {'text': 'üè• Sick Leave', 'value': 'sick leave', 'description': 'Medical leave policies and procedures'},
            {'text': '‚è∞ Working Hours', 'value': 'working hours', 'description': 'Schedule for admin and academic staff'},
            {'text': 'üéÅ Employee Benefits', 'value': 'benefits', 'description': 'Health insurance, visa, holidays'},
            {'text': 'üëî Code of Conduct', 'value': 'conduct', 'description': 'Professional standards and dress code'},
            {'text': '‚öñÔ∏è Disciplinary Procedures', 'value': 'disciplinary', 'description': 'Warning system and processes'}
        ],
        'footer': "üí° Could you please choose one of these topics or rephrase your question?\n\n*Have a great day! I am always here to guide you. Do you want to know more?* üòä"
    }

# Main header
st.markdown("""
<div class="main-header">
    <h1>ü§ñ LGL Employee Helper</h1>
    <p style="font-size: 1.2rem; margin-top: 1rem; opacity: 0.9;">Alistar's Personnel Employee Handbook</p>
</div>
""", unsafe_allow_html=True)

# Quick action buttons with icons
st.markdown("### üöÄ Quick Topics:")
col1, col2, col3 = st.columns(3)

with col1:
    if st.button("üèñÔ∏è Annual Leave", key="leave_btn", help="Learn about annual leave policies and vacation days"):
        question = 'Tell me about annual leave'
        st.session_state.messages.append({'role': 'user', 'content': question})
        response = process_user_question('annual leave')
        # Handle the new response format
        content = response['content'] if isinstance(response, dict) else response
        st.session_state.messages.append({'role': 'assistant', 'content': content, 'response_data': response})
        st.session_state.processing = False
        st.rerun()
    
    if st.button("üè• Sick Leave", key="sick_btn", help="Learn about sick leave policies and medical procedures"):
        question = 'Tell me about sick leave'
        st.session_state.messages.append({'role': 'user', 'content': question})
        response = process_user_question('sick leave')
        # Handle the new response format
        content = response['content'] if isinstance(response, dict) else response
        st.session_state.messages.append({'role': 'assistant', 'content': content, 'response_data': response})
        st.session_state.processing = False
        st.rerun()

with col2:
    if st.button("‚è∞ Working Hours", key="hours_btn", help="Learn about working schedules and time policies"):
        question = 'Tell me about working hours'
        st.session_state.messages.append({'role': 'user', 'content': question})
        response = process_user_question('working hours')
        # Handle the new response format
        content = response['content'] if isinstance(response, dict) else response
        st.session_state.messages.append({'role': 'assistant', 'content': content, 'response_data': response})
        st.session_state.processing = False
        st.rerun()
    
    if st.button("üéÅ Benefits", key="benefits_btn", help="Learn about employee benefits and insurance"):
        question = 'Tell me about employee benefits'
        st.session_state.messages.append({'role': 'user', 'content': question})
        response = process_user_question('benefits')
        # Handle the new response format
        content = response['content'] if isinstance(response, dict) else response
        st.session_state.messages.append({'role': 'assistant', 'content': content, 'response_data': response})
        st.session_state.processing = False
        st.rerun()

with col3:
    if st.button("üëî Code of Conduct", key="conduct_btn", help="Learn about professional standards and dress code"):
        question = 'Tell me about code of conduct'
        st.session_state.messages.append({'role': 'user', 'content': question})
        response = process_user_question('conduct')
        # Handle the new response format
        content = response['content'] if isinstance(response, dict) else response
        st.session_state.messages.append({'role': 'assistant', 'content': content, 'response_data': response})
        st.session_state.processing = False
        st.rerun()
    
    if st.button("‚öñÔ∏è Disciplinary", key="disciplinary_btn", help="Learn about disciplinary procedures and warnings"):
        question = 'Tell me about disciplinary procedures'
        st.session_state.messages.append({'role': 'user', 'content': question})
        response = process_user_question('disciplinary')
        # Handle the new response format
        content = response['content'] if isinstance(response, dict) else response
        st.session_state.messages.append({'role': 'assistant', 'content': content, 'response_data': response})
        st.session_state.processing = False
        st.rerun()

# Chat input using form to prevent auto-rerun
st.markdown("### üí¨ Chat with LGL Assistant")

# Display chat messages
for i, message in enumerate(st.session_state.messages):
    if message['role'] == 'assistant':
        # Display the bot message
        st.markdown(f"""
        <div class="bot-message">
            ü§ñ <strong>LGL Assistant:</strong><br>
            {message['content'].replace('**', '<strong>').replace('**', '</strong>').replace('*', '<em>').replace('*', '</em>').replace('\n', '<br>')}
        </div>
        """, unsafe_allow_html=True)
        
        # Check if this message has options to display
        if 'response_data' in message and isinstance(message['response_data'], dict):
            response_data = message['response_data']
            if response_data.get('type') == 'options' and 'options' in response_data:
                # Display option buttons
                st.markdown("**Choose an option:**")
                
                # Create columns for buttons
                num_options = len(response_data['options'])
                if num_options <= 2:
                    cols = st.columns(num_options)
                elif num_options <= 4:
                    cols = st.columns(2)
                else:
                    cols = st.columns(3)
                
                for j, option in enumerate(response_data['options']):
                    col_index = j % len(cols)
                    with cols[col_index]:
                        # Create unique key for each button
                        button_key = f"option_{i}_{j}_{option['value'].replace(' ', '_')}"
                        if st.button(
                            option['text'],
                            key=button_key,
                            help=option.get('description', ''),
                            use_container_width=True
                        ):
                            # Add user message for the selected option
                            st.session_state.messages.append({
                                'role': 'user', 
                                'content': f"Tell me about {option['value']}"
                            })
                            
                            # Process the selected option
                            with st.spinner('üîç Searching through the handbook...'):
                                time.sleep(0.5)
                                response = process_user_question(option['value'])
                                content = response['content'] if isinstance(response, dict) else response
                                st.session_state.messages.append({
                                    'role': 'assistant', 
                                    'content': content,
                                    'response_data': response
                                })
                            
                            st.session_state.processing = False
                            st.rerun()
                
                # Display footer if available
                if 'footer' in response_data and response_data['footer']:
                    st.markdown(f"""
                    <div class="bot-message" style="margin-top: 10px; font-size: 0.9rem; opacity: 0.8;">
                        {response_data['footer'].replace('**', '<strong>').replace('**', '</strong>').replace('*', '<em>').replace('*', '</em>').replace('\n', '<br>')}
                    </div>
                    """, unsafe_allow_html=True)
                
                st.markdown("---")  # Separator after options
    else:
        # User message
        st.markdown(f"""
        <div class="user-message">
            üë§ <strong>You:</strong><br>
            {message['content']}
        </div>
        """, unsafe_allow_html=True)

# Use form for input to prevent auto-rerun
with st.form(key='chat_form', clear_on_submit=True):
    user_input = st.text_input("üí≠ Ask me anything about the Employee Handbook...", 
                               placeholder="e.g., How do I apply for annual leave?",
                               key="chat_input")
    submit_button = st.form_submit_button("üöÄ Send")
    
    if submit_button and user_input and user_input.strip():
        # Prevent duplicate processing
        if user_input != st.session_state.last_input and not st.session_state.processing:
            st.session_state.processing = True
            st.session_state.last_input = user_input
            
            # Add user message
            st.session_state.messages.append({'role': 'user', 'content': user_input})
            
            # Process and add assistant response
            with st.spinner('üîç Searching through the handbook...'):
                time.sleep(1 + random.uniform(0.5, 1.5))  # Simulate processing time
                response = process_user_question(user_input)
                # Handle the new response format
                content = response['content'] if isinstance(response, dict) else response
                st.session_state.messages.append({
                    'role': 'assistant', 
                    'content': content,
                    'response_data': response
                })
            
            st.session_state.processing = False
            st.rerun()

# Footer
st.markdown("---")
st.markdown("""
<div style="text-align: center; color: #666; padding: 2rem;">
    <p>üè¢ <strong>Alistar Handbook</strong> - Employee Handbook Assistant</p>
    <p>üìç 605, Park Avenue , Dubai Silicon Oasis</p>
    <p><em>For additional HR support, please contact the HR Department</em></p>
</div>
""", unsafe_allow_html=True)