import streamlit as st
import re
import time
import random

# Configure the page
st.set_page_config(
    page_title="LGL Employee Helper",
    page_icon="ü§ñ",
    layout="wide",
    initial_sidebar_state="collapsed"
)

# Custom CSS for styling
st.markdown("""
<style>
    .main-header {
        background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
        padding: 2rem;
        border-radius: 20px;
        color: white;
        text-align: center;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    
    .bot-message {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        padding: 1rem 1.5rem;
        border-radius: 18px;
        margin: 1rem 0;
        border-left: 4px solid #667eea;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .user-message {
        background: linear-gradient(135deg, #667eea, #764ba2);
        padding: 1rem 1.5rem;
        border-radius: 18px;
        margin: 1rem 0;
        color: white;
        margin-left: 2rem;
        box-shadow: 0 2px 10px rgba(102, 126, 234, 0.3);
    }
    
    .quick-action {
        background: linear-gradient(135deg, #ecf0f1, #bdc3c7);
        border: none;
        padding: 0.5rem 1rem;
        border-radius: 25px;
        margin: 0.25rem;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
    }
    
    .quick-action:hover {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        transform: translateY(-2px);
    }
    
    .stTextInput > div > div > input {
        border-radius: 25px;
        padding: 1rem;
        border: 2px solid #e0e0e0;
        font-size: 1rem;
    }
    
    .stTextInput > div > div > input:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .block-container {
        padding-top: 2rem;
        padding-bottom: 2rem;
    }
</style>
""", unsafe_allow_html=True)

# Employee Handbook Data
HANDBOOK_DATA = {
    'leave': {
        'title': 'Annual Leave Policy',
        'content': """üìÖ **Annual Leave Entitlement:**

‚Ä¢ **First Year:** 20 working days (after probation completion)
‚Ä¢ **Subsequent Years:** 22 working days from second year onward
‚Ä¢ **Notice Required:** Minimum twice the duration of leave requested
‚Ä¢ **Peak Periods:** July and August may have restrictions

**How to Apply:**
1. Submit Annual Leave Form to Line Manager
2. First-come, first-served basis
3. Subject to operational requirements

**Carry Over Rules:**
‚Ä¢ Administrative Staff: Maximum 7 days per year
‚Ä¢ Teaching Staff: Not permitted to carry over

üìã **Reference:** Section 9.2 of Employee Handbook"""
    },
    
    'sick': {
        'title': 'Sick Leave Policy',
        'content': """üè• **Sick Leave Entitlement (per year):**

‚Ä¢ **Total:** 90 calendar days after 3 months post-probation
‚Ä¢ **Full Pay:** First 15 calendar days
‚Ä¢ **Half Pay:** Next 30 calendar days
‚Ä¢ **No Pay:** Next 45 days

**Application Process:**
‚Ä¢ Notify manager within 1.5 hours (academic) or 1 hour (admin)
‚Ä¢ Complete Sick Leave Form upon return
‚Ä¢ Medical certificate required for absence beyond 2 days

‚ö†Ô∏è **Important:** Available only after completing probationary period

üìã **Reference:** Section 9.3 of Employee Handbook"""
    },
    
    'working hours': {
        'title': 'Working Hours',
        'content': """‚è∞ **Working Hours:**

**Administrative Staff:**
‚Ä¢ Days: Monday ‚Äì Friday
‚Ä¢ Hours: 9:00am ‚Äì 6:00pm
‚Ä¢ Overtime: Paid at management's discretion

**Academic Staff:**
‚Ä¢ Days: Monday to Friday
‚Ä¢ Sessions: 9am-12pm, 12pm-3pm, 3pm-6pm
‚Ä¢ Minimum: 2 sessions per day
‚Ä¢ Flexible scheduling based on demand

**Ramadan Hours:**
‚Ä¢ 2 hours reduction per day (if normal hours exceed 8 hours)
‚Ä¢ 1 week notice for revised times
‚Ä¢ Applies to administrative staff only

üìã **Reference:** Section 5 of Employee Handbook"""
    },
    
    'benefits': {
        'title': 'Employee Benefits',
        'content': """üéÅ **Comprehensive Benefits Package:**

**Health Insurance:**
‚Ä¢ Basic Cover: First 6 months (probation)
‚Ä¢ Comprehensive Cover: After 6 months

**Visa Sponsorship:**
‚Ä¢ Company-sponsored resident visa
‚Ä¢ Dependent visas available (employee covers costs)

**Leave Benefits:**
‚Ä¢ Annual Leave: 20-22 days
‚Ä¢ Sick Leave: Up to 90 days
‚Ä¢ Maternity: 60 days (45 full pay + 15 half pay)
‚Ä¢ Parental: 5 days (male/female)
‚Ä¢ Bereavement: 3-5 days

**National Holidays:**
‚Ä¢ New Year's Day ‚Ä¢ Eid Al Fitr (2 days) ‚Ä¢ Eid Al Adha (3 days)
‚Ä¢ Prophet's Birthday ‚Ä¢ National Day ‚Ä¢ Isra & Al Miraj

üìã **Reference:** Section 9 of Employee Handbook"""
    },
    
    'conduct': {
        'title': 'Code of Conduct',
        'content': """üëî **Professional Standards:**

**Employee Duties:**
‚Ä¢ Create culture of mutual respect
‚Ä¢ Exercise reasonable skill and care
‚Ä¢ Maintain confidentiality
‚Ä¢ Professional language at all times
‚Ä¢ Healthy work-life balance

**Dress Code:**
‚Ä¢ Smart, professional attire
‚Ä¢ Clean, tidy, and appropriate clothing
‚Ä¢ Cover tattoos where possible
‚Ä¢ No torn, transparent, or inappropriate clothing
‚Ä¢ Religious dress permitted unless safety risk

**Safeguarding (Students):**
‚Ä¢ No physical contact with students
‚Ä¢ Avoid being alone with students
‚Ä¢ Maintain professional boundaries
‚Ä¢ No personal relationships
‚Ä¢ Report any concerns to management

üìã **Reference:** Section 6 of Employee Handbook"""
    },
    
    'disciplinary': {
        'title': 'Disciplinary Procedures',
        'content': """‚öñÔ∏è **Disciplinary Process:**

**Warning System:**
‚Ä¢ Verbal Warning: 6 months validity
‚Ä¢ First Written: 12 months validity
‚Ä¢ Final Written: 12 months validity

**Minor Misconduct Examples:**
‚Ä¢ Persistent lateness ‚Ä¢ Unauthorized absence
‚Ä¢ Failure to follow procedures ‚Ä¢ Private work during hours

**Gross Misconduct Examples:**
‚Ä¢ Theft of company property ‚Ä¢ Breach of confidentiality
‚Ä¢ Being unfit for duty ‚Ä¢ Safeguarding violations
‚Ä¢ Discrimination/harassment ‚Ä¢ Bringing company into disrepute

**Process:**
1. Formal investigation by HR
2. Written notification of hearing
3. Disciplinary hearing with representation
4. Decision communicated in writing
5. Right to appeal within 5 days

üìã **Reference:** Section 12 of Employee Handbook"""
    },
    
    'covid': {
        'title': 'COVID-19 Policy',
        'content': """ü¶† **COVID-19 Guidelines:**

**If Showing Symptoms:**
‚Ä¢ Immediate isolation and hospital referral
‚Ä¢ Cannot return until PCR result obtained
‚Ä¢ 7-day quarantine for close contacts

**Vaccination Requirements:**
‚Ä¢ Proof of vaccination required
‚Ä¢ Weekly PCR tests if unvaccinated
‚Ä¢ Medical exemptions with doctor's certificate

**Workplace Protocols:**
‚Ä¢ Regular sanitization
‚Ä¢ Social distancing measures
‚Ä¢ Online teaching capabilities for quarantine

üìã **Reference:** Section 10 of Employee Handbook"""
    },
    
    'termination': {
        'title': 'Termination & Gratuity',
        'content': """üìã **End of Service:**

**Notice Periods:**
‚Ä¢ Limited Contract: No notice (expires at end date)
‚Ä¢ Unlimited Contract: Minimum 30 calendar days

**Gratuity Calculation:**
‚Ä¢ 21 days basic pay for each of first 5 years
‚Ä¢ 30 days basic pay for each additional year
‚Ä¢ Maximum: 2 years' total pay

**Early Termination:**
‚Ä¢ Employer: 3 months' compensation
‚Ä¢ Employee: Half of 3 months' compensation

**Resignation Gratuity (Unlimited Contract):**
‚Ä¢ 1-3 years: 2/3 reduction
‚Ä¢ 3-5 years: 1/3 reduction
‚Ä¢ 5+ years: No reduction

üìã **Reference:** Section 18 of Employee Handbook"""
    }
}

# Initialize session state
if 'messages' not in st.session_state:
    st.session_state.messages = []
    st.session_state.messages.append({
        'role': 'assistant',
        'content': 'üëã Hello! I am your **LGL Employee Helper**. Ask me anything about the ES Training DMCC Employee Handbook!\n\nI can help you with policies, procedures, benefits, and much more. What would you like to know?'
    })

def process_user_question(question):
    """Process user question and return appropriate response"""
    question_lower = question.lower()
    
    # Check for topic matches
    for topic, data in HANDBOOK_DATA.items():
        if topic in question_lower or any(keyword in question_lower for keyword in [
            'annual leave' if topic == 'leave' else topic,
            'vacation' if topic == 'leave' else '',
            'holiday' if topic == 'leave' else '',
            'illness' if topic == 'sick' else '',
            'medical' if topic == 'sick' else '',
            'schedule' if topic == 'working hours' else '',
            'time' if topic == 'working hours' else '',
            'insurance' if topic == 'benefits' else '',
            'visa' if topic == 'benefits' else '',
            'dress' if topic == 'conduct' else '',
            'behavior' if topic == 'conduct' else '',
            'warning' if topic == 'disciplinary' else '',
            'misconduct' if topic == 'disciplinary' else '',
            'coronavirus' if topic == 'covid' else '',
            'quarantine' if topic == 'covid' else '',
            'resignation' if topic == 'termination' else '',
            'gratuity' if topic == 'termination' else ''
        ]):
            return f"üìñ **{data['title']}**\n\n{data['content']}\n\n*Have a great day! I am always here to guide you. Do you want to know more?* üòä"
    
    # Default response for unrecognized questions
    return """I understand you're looking for information from the Employee Handbook. I can help you with:

üîπ **Annual Leave** - Vacation days and application process
üîπ **Sick Leave** - Medical leave policies and procedures  
üîπ **Working Hours** - Schedule for admin and academic staff
üîπ **Employee Benefits** - Health insurance, visa, holidays
üîπ **Code of Conduct** - Professional standards and dress code
üîπ **Disciplinary Procedures** - Warning system and processes
üîπ **COVID-19 Policy** - Health and safety protocols
üîπ **Termination & Gratuity** - End of service procedures

Please ask about any of these topics, and I'll provide detailed information!

*Have a great day! I am always here to guide you. Do you want to know more?* üòä"""

# Main header
st.markdown("""
<div class="main-header">
    <h1>ü§ñ LGL Employee Helper</h1>
    <p style="font-size: 1.2rem; margin-top: 1rem; opacity: 0.9;">Your intelligent guide to the ES Training DMCC Employee Handbook</p>
</div>
""", unsafe_allow_html=True)

# Quick action buttons
st.markdown("### üöÄ Quick Topics:")
col1, col2, col3 = st.columns(3)

with col1:
    if st.button("üìÖ Annual Leave", key="leave_btn"):
        st.session_state.messages.append({'role': 'user', 'content': 'Tell me about annual leave'})
        response = process_user_question('annual leave')
        st.session_state.messages.append({'role': 'assistant', 'content': response})
    
    if st.button("üè• Sick Leave", key="sick_btn"):
        st.session_state.messages.append({'role': 'user', 'content': 'Tell me about sick leave'})
        response = process_user_question('sick leave')
        st.session_state.messages.append({'role': 'assistant', 'content': response})

with col2:
    if st.button("‚è∞ Working Hours", key="hours_btn"):
        st.session_state.messages.append({'role': 'user', 'content': 'Tell me about working hours'})
        response = process_user_question('working hours')
        st.session_state.messages.append({'role': 'assistant', 'content': response})
    
    if st.button("üéÅ Benefits", key="benefits_btn"):
        st.session_state.messages.append({'role': 'user', 'content': 'Tell me about employee benefits'})
        response = process_user_question('benefits')
        st.session_state.messages.append({'role': 'assistant', 'content': response})

with col3:
    if st.button("üëî Code of Conduct", key="conduct_btn"):
        st.session_state.messages.append({'role': 'user', 'content': 'Tell me about code of conduct'})
        response = process_user_question('conduct')
        st.session_state.messages.append({'role': 'assistant', 'content': response})
    
    if st.button("‚öñÔ∏è Disciplinary", key="disciplinary_btn"):
        st.session_state.messages.append({'role': 'user', 'content': 'Tell me about disciplinary procedures'})
        response = process_user_question('disciplinary')
        st.session_state.messages.append({'role': 'assistant', 'content': response})

# Chat interface
st.markdown("### üí¨ Chat with LGL Assistant")

# Display chat messages
for message in st.session_state.messages:
    if message['role'] == 'assistant':
        st.markdown(f"""
        <div class="bot-message">
            ü§ñ <strong>LGL Assistant:</strong><br>
            {message['content'].replace('**', '<strong>').replace('**', '</strong>').replace('*', '<em>').replace('*', '</em>').replace('\n', '<br>')}
        </div>
        """, unsafe_allow_html=True)
    else:
        st.markdown(f"""
        <div class="user-message">
            üë§ <strong>You:</strong><br>
            {message['content']}
        </div>
        """, unsafe_allow_html=True)

# Chat input
user_input = st.text_input("üí≠ Ask me anything about the Employee Handbook...", key="user_input", placeholder="e.g., How do I apply for annual leave?")

if user_input:
    # Add user message
    st.session_state.messages.append({'role': 'user', 'content': user_input})
    
    # Process and add assistant response
    with st.spinner('üîç Searching through the handbook...'):
        time.sleep(1 + random.uniform(0.5, 1.5))  # Simulate processing time
        response = process_user_question(user_input)
        st.session_state.messages.append({'role': 'assistant', 'content': response})
    
    # Rerun to update the display
    st.rerun()

# Footer
st.markdown("---")
st.markdown("""
<div style="text-align: center; color: #666; padding: 2rem;">
    <p>üè¢ <strong>ES Training DMCC</strong> - Employee Handbook Assistant</p>
    <p>üìç 15th Floor, Mazaya Business Avenue, BB1, JLT, Dubai, UAE</p>
    <p><em>For additional HR support, please contact the HR Department</em></p>
</div>
""", unsafe_allow_html=True)